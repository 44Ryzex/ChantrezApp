<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<link rel="stylesheet" href="/css/style.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
.dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
.card { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s; }
.card:hover { transform: translateY(-5px); border-color: rgba(124,58,237,0.5); }
.card-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 28px; }
.card-content h3 { font-size: 14px; color: #9ca3af; margin-bottom: 8px; }
.card-value { font-size: 24px; font-weight: 600; color: #fff; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 8px; color: #9ca3af; font-size: 14px; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 14px; }
.form-group select option { background: #1a1a1a; color: #fff; padding: 10px; }
.form-group textarea { min-height: 100px; resize: vertical; }
.btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; transition: all 0.3s; }
.btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102,126,234,0.3); }
.btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #fff; }
.btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff; }
.section { background: rgba(255,255,255,0.03); border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
.section-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #fff; }
.logs-container { max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; }
.log-item { padding: 10px; margin-bottom: 8px; border-radius: 6px; font-size: 13px; font-family: monospace; }
.log-success { background: rgba(16,185,129,0.1); border-left: 3px solid #10b981; color: #10b981; }
.log-error { background: rgba(239,68,68,0.1); border-left: 3px solid #ef4444; color: #ef4444; }
.log-info { background: rgba(59,130,246,0.1); border-left: 3px solid #3b82f6; color: #3b82f6; }
.log-warning { background: rgba(245,158,11,0.1); border-left: 3px solid #f59e0b; color: #f59e0b; }
.toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px; }
.toggle-slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; }
input:checked + .toggle-slider { background-color: #667eea; }
input:checked + .toggle-slider:before { transform: translateX(26px); }
.status-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-top: 15px; }
.status-active { border-left: 4px solid #10b981; }
.status-inactive { border-left: 4px solid #ef4444; }

/* Pre-load categories as collapsed to prevent flickering */
.category-content.pre-collapsed { display: none; }
.toggle-icon.pre-rotated { transform: rotate(180deg); }
</style>
</head>
<body>
<div class="container">
<aside class="sidebar">
<div class="sidebar-header">
<div class="logo"><i class="fas fa-robot"></i><span>Ch√¢ntr√©z MT Bot</span></div>
</div>
<nav class="sidebar-nav">
<a href="/dashboard" class="nav-item <%= page === 'dashboard' ? 'active' : '' %>">
<i class="fas fa-home"></i><span>Dashboard</span>
</a>
<a href="/upgrade" class="nav-item <%= page === 'upgrade' ? 'active' : '' %>">
<i class="fas fa-key"></i><span>Upgrade Account</span>
</a>
<div class="nav-category">
<div class="category-header" onclick="toggleCategory('tools')">
<i class="fas fa-tools"></i><span>Tools</span><i class="fas fa-chevron-down toggle-icon"></i>
</div>
<div class="category-content" id="tools-content">
<a href="/bot-setup" class="nav-item <%= page === 'bot-setup' ? 'active' : '' %> <%= user.accountType === 'free' ? 'disabled' : '' %>">
<i class="fas fa-cog"></i><span>Setup</span><% if (user.accountType === 'free') { %><i class="fas fa-lock lock-icon"></i><% } %>
</a>
<a href="/ingame-anc" class="nav-item <%= page === 'ingame-anc' ? 'active' : '' %> <%= user.accountType === 'free' ? 'disabled' : '' %>">
<i class="fas fa-gamepad"></i><span>Ingame Test</span><% if (user.accountType === 'free') { %><i class="fas fa-lock lock-icon"></i><% } %>
</a>
<a href="/activity-test" class="nav-item <%= page === 'activity-test' ? 'active' : '' %> <%= user.accountType === 'free' ? 'disabled' : '' %>">
<i class="fas fa-bolt"></i><span>Activity Test</span><% if (user.accountType === 'free') { %><i class="fas fa-lock lock-icon"></i><% } %>
</a>
<a href="/ticket" class="nav-item <%= page === 'ticket' ? 'active' : '' %> <%= user.accountType === 'free' ? 'disabled' : '' %>">
<i class="fas fa-ticket-alt"></i><span>Ticket</span><% if (user.accountType === 'free') { %><i class="fas fa-lock lock-icon"></i><% } %>
</a>
<a href="/dmanc" class="nav-item <%= page === 'dmanc' ? 'active' : '' %> <%= user.accountType === 'free' ? 'disabled' : '' %>">
<i class="fas fa-envelope"></i><span>DM Announcement</span><% if (user.accountType === 'free') { %><i class="fas fa-lock lock-icon"></i><% } %>
</a>
</div>
</div>
<div class="nav-category">
<div class="category-header" onclick="toggleCategory('guard')">
<i class="fas fa-shield-alt"></i><span>Guard</span><i class="fas fa-chevron-down toggle-icon"></i>
</div>
<div class="category-content" id="guard-content">
<a href="/radar-list" class="nav-item <%= page === 'radar-list' ? 'active' : '' %> <%= user.accountType === 'free' ? 'disabled' : '' %>">
<i class="fas fa-crosshairs"></i><span>Radar List</span><% if (user.accountType === 'free') { %><i class="fas fa-lock lock-icon"></i><% } %>
</a>
<a href="/channel-protection" class="nav-item <%= page === 'channel-protection' ? 'active' : '' %> <%= user.accountType === 'free' ? 'disabled' : '' %>">
<i class="fas fa-hashtag"></i><span>Channel Protection</span><% if (user.accountType === 'free') { %><i class="fas fa-lock lock-icon"></i><% } %>
</a>
<a href="/member-protection" class="nav-item <%= page === 'member-protection' ? 'active' : '' %> <%= user.accountType === 'free' ? 'disabled' : '' %>">
<i class="fas fa-user-shield"></i><span>Member Protection</span><% if (user.accountType === 'free') { %><i class="fas fa-lock lock-icon"></i><% } %>
</a>
<a href="/role-protection" class="nav-item <%= page === 'role-protection' ? 'active' : '' %> <%= user.accountType === 'free' ? 'disabled' : '' %>">
<i class="fas fa-tags"></i><span>Role Protection</span><% if (user.accountType === 'free') { %><i class="fas fa-lock lock-icon"></i><% } %>
</a>
<a href="/guard-log" class="nav-item <%= page === 'guard-log' ? 'active' : '' %> <%= user.accountType === 'free' ? 'disabled' : '' %>">
<i class="fas fa-clipboard-list"></i><span>Guard Log</span><% if (user.accountType === 'free') { %><i class="fas fa-lock lock-icon"></i><% } %>
</a>
</div>
</div>
<% if (user.accountType === 'admin') { %>
<div class="nav-category">
<div class="category-header" onclick="toggleCategory('admin')">
<i class="fas fa-crown"></i><span>Admin Tools</span><i class="fas fa-chevron-down toggle-icon"></i>
</div>
<div class="category-content" id="admin-content">
<a href="/admin/users" class="nav-item <%= page === 'admin-users' ? 'active' : '' %>">
<i class="fas fa-users"></i><span>Users</span>
</a>
<a href="/admin/keys" class="nav-item <%= page === 'admin-keys' ? 'active' : '' %>">
<i class="fas fa-key"></i><span>Keys</span>
</a>
<a href="/logs" class="nav-item <%= page === 'logs' ? 'active' : '' %>">
<i class="fas fa-list"></i><span>Logs</span>
</a>
</div>
</div>
<% } %>
</nav>
<div class="sidebar-footer">
<div class="user-info">
<div class="user-avatar"><i class="fas fa-user-circle"></i></div>
<div class="user-details">
<div class="user-name"><%= user.username %></div>
<div class="user-type <%= user.accountType %>"><%= user.accountType.toUpperCase() %></div>
</div>
<a href="/logout" class="logout-btn" title="Logout"><i class="fas fa-sign-out-alt"></i></a>
</div>
<div class="credits">made by <strong>ryzex.thy</strong></div>
</div>
</aside>
<main class="main-content">
<header class="header">
<h1><%= page === 'dashboard' ? 'Dashboard' : page.replace('-', ' ').toUpperCase() %></h1>
</header>

<div id="content">
<% if (page === 'dashboard') { %>
<div class="welcome-section" style="background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%); border-radius: 15px; padding: 30px; margin-bottom: 30px; border: 1px solid rgba(102,126,234,0.2);">
<h2 style="font-size: 28px; margin-bottom: 10px;">üéâ Welcome, <%= user.username %>!</h2>
<p style="color: #9ca3af; font-size: 16px;">Account: <strong style="color: #fff;"><%= user.accountType.toUpperCase() %></strong></p>
<% if (user.accountType === 'free') { %>
<div class="warning-box" style="background: rgba(245,158,11,0.1); border-left: 4px solid #f59e0b; padding: 15px; margin-top: 20px; border-radius: 8px;">
<i class="fas fa-info-circle" style="color: #f59e0b; margin-right: 10px;"></i>
<span style="color: #f59e0b;">Free accounts can only view UI. Upgrade to Normal/Admin for full access.</span>
</div>
<% } %>
</div>

<div class="dashboard-grid">
<div class="card">
<div class="card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
<i class="fas fa-clock"></i>
</div>
<div class="card-content">
<h3>Uptime</h3>
<p class="card-value" id="uptime">-</p>
</div>
</div>

<div class="card">
<div class="card-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
<i class="fas fa-users"></i>
</div>
<div class="card-content">
<h3>Account Type</h3>
<p class="card-value"><%= user.accountType.toUpperCase() %></p>
</div>
</div>
</div>
</div>

<% } else if (page === 'upgrade') { %>
<div class="section">
<h3 class="section-title">üîë Upgrade Your Account</h3>
<p style="color: #9ca3af; margin-bottom: 20px;">Enter your key to upgrade your account.</p>
<form id="upgradeForm">
<div class="form-group">
<label>Key</label>
<input type="text" name="key" placeholder="Enter your key" required>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-arrow-up"></i> Upgrade Account</button>
</form>
</div>

<% } else if (page === 'bot-setup') { %>
<div class="section">
<h3 class="section-title">‚öôÔ∏è Bot Setup</h3>
<form id="configForm">
<div class="form-group">
<label>Bot Token</label>
<input type="password" name="token" value="<%= user.botToken || '' %>" placeholder="Enter your bot token">
</div>
<div class="form-group">
<label>Guild ID (Server ID)</label>
<input type="text" name="guildId" value="<%= user.guildId || '' %>" placeholder="Enter your server ID">
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
</form>
</div>

<div class="section">
<h3 class="section-title">üéÆ Bot Control</h3>
<div style="display: flex; gap: 15px;">
<button class="btn btn-success" onclick="controlBot('start')"><i class="fas fa-play"></i> Start</button>
<button class="btn btn-danger" onclick="controlBot('stop')"><i class="fas fa-stop"></i> Stop</button>
</div>
</div>

<% } else if (page === 'ingame-anc') { %>
<div class="section">
<h3 class="section-title">üéÆ Ingame Announcement</h3>
<form id="ingameForm">
<div class="form-group">
<label>Channel</label>
<select name="channelId" id="channelSelect" required>
<option value="">Select channel</option>
</select>
</div>
<div class="form-group">
<label>Title</label>
<input type="text" name="title" value="">
</div>
<div class="form-group">
<label>Announcement Text</label>
<textarea name="ancText" required></textarea>
</div>
<div class="form-group">
<label>Number of People</label>
<input type="number" name="numberOfPeople" min="1" value="5" required>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Send</button>
</form>
</div>

<% } else if (page === 'activity-test') { %>
<div class="section">
<h3 class="section-title">‚ö° Activity Test</h3>
<form id="activityForm">
<div class="form-group">
<label>Channel</label>
<select name="channelId" id="channelSelect" required>
<option value="">Select channel</option>
</select>
</div>
<div class="form-group">
<label>Title</label>
<input type="text" name="title" value="">
</div>
<div class="form-group">
<label>Description</label>
<textarea name="ancText" required></textarea>
</div>
<div class="form-group">
<label>Time (Minutes)</label>
<input type="number" name="timeLimit" min="1" value="5" required>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-bolt"></i> Start</button>
</form>
</div>

<% } else if (page === 'ticket') { %>
<div class="section">
<h3 class="section-title">üé´ Ticket System</h3>
<form id="ticketForm">
<div class="form-group">
<label>Ticket Channel</label>
<select name="ticketChannel" id="ticketChannelSelect" required>
<option value="">Select channel</option>
</select>
</div>
<div class="form-group">
<label>Staff Role</label>
<select name="staffRole" id="staffRoleSelect" required>
<option value="">Select role</option>
</select>
</div>
<div class="form-group">
<label>Tickets Category</label>
<select name="ticketsCategory" id="ticketsCategorySelect" required>
<option value="">Select category</option>
</select>
</div>
<div class="form-group">
<label>Closed Category</label>
<select name="closedCategory" id="closedCategorySelect">
<option value="">Select category (optional)</option>
</select>
</div>
<div class="form-group">
<label>Embed Title</label>
<input type="text" name="embedTitle" value="">
</div>
<div class="form-group">
<label>Embed Description</label>
<textarea name="embedDescription"></textarea>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save & Create Button</button>
</form>
</div>

<% } else if (page === 'dmanc') { %>
<div class="section">
<h3 class="section-title">üì® DM Announcement</h3>
<form id="dmForm">
<div class="form-group">
<label>Title</label>
<input type="text" name="title" required>
</div>
<div class="form-group">
<label>Message</label>
<textarea name="text" required></textarea>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-envelope"></i> Send</button>
</form>
</div>

<% } else if (page === 'give-role') { %>
<div class="section">
<h3 class="section-title">üè∑Ô∏è Give Role</h3>
<form id="roleForm">
<div class="form-group">
<label>Channel</label>
<select name="channelId" id="channelSelect" required>
<option value="">Select channel</option>
</select>
</div>
<div class="form-group">
<label>Role to Give</label>
<select name="roleId" id="roleSelect" required>
<option value="">Select role</option>
</select>
</div>
<div class="form-group">
<label>Emoji</label>
<input type="text" name="emoji" value="‚úÖ" required>
</div>
<div class="form-group">
<label>Button Text</label>
<input type="text" name="buttonText" value="Get Role" required>
</div>
<div class="form-group">
<label>Embed Title</label>
<input type="text" name="embedTitle" value="Role Selection">
</div>
<div class="form-group">
<label>Embed Description</label>
<textarea name="embedDescription"></textarea>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Create</button>
</form>
</div>

<% } else if (page === 'logs') { %>
<div class="section">
<h3 class="section-title">üìã System Logs</h3>
<div class="logs-container" id="logsContainer" style="max-height: 600px;">
<% if (logs && logs.length > 0) { %>
<% logs.forEach(log => { %>
<div class="log-item log-<%= log.type %>">
[<%= new Date(log.timestamp).toLocaleString('en-US') %>] <%= log.message %>
</div>
<% }); %>
<% } else { %>
<p style="color: #6b7280; text-align: center; padding: 20px;">No logs yet</p>
<% } %>
</div>
</div>

<% } else if (page === 'admin-users') { %>
<div class="section">
<h3 class="section-title">üë• User Management</h3>
<table style="width: 100%; color: #fff;">
<thead>
<tr style="background: rgba(255,255,255,0.05);">
<th style="padding: 12px; text-align: left;">Username</th>
<th style="padding: 12px; text-align: left;">Email</th>
<th style="padding: 12px; text-align: left;">Type</th>
<th style="padding: 12px; text-align: left;">IP Address</th>
<th style="padding: 12px; text-align: left;">Status</th>
<th style="padding: 12px; text-align: left;">Actions</th>
</tr>
</thead>
<tbody>
<% allUsers.forEach(u => { %>
<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
<td style="padding: 12px;"><%= u.username %></td>
<td style="padding: 12px;"><%= u.email %></td>
<td style="padding: 12px;"><span style="background: <%= u.accountType === 'admin' ? '#7c3aed' : u.accountType === 'normal' ? '#10b981' : '#6b7280' %>; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><%= u.accountType.toUpperCase() %></span></td>
<td style="padding: 12px;"><code style="font-size: 11px; color: #9ca3af; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px;"><%= u.allowedIP %></code></td>
<td style="padding: 12px;"><%= u.banned ? 'üî¥ Banned' : 'üü¢ Active' %></td>
<td style="padding: 12px;">
<div style="display: flex; gap: 5px; flex-wrap: wrap;">
<% if (!u.banned) { %>
<button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="banUser('<%= u.id %>')">Ban</button>
<% } else { %>
<button class="btn btn-success" style="padding: 6px 12px; font-size: 12px;" onclick="unbanUser('<%= u.id %>')">Unban</button>
<% } %>
<button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="resetHWID('<%= u.id %>')">HWID Reset</button>
<button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteUser('<%= u.id %>', '<%= u.username %>')"><i class="fas fa-trash"></i></button>
</div>
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>

<% } else if (page === 'admin-keys') { %>
<div class="section">
<h3 class="section-title">üîë Key Management</h3>
<form id="keyForm" style="margin-bottom: 20px;">
<div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
<div class="form-group" style="margin: 0;">
<label>Key Type</label>
<select name="type" required>
<option value="normal">Normal</option>
<option value="admin">Admin</option>
</select>
</div>
<div class="form-group" style="margin: 0;">
<label>Amount</label>
<input type="number" name="amount" min="1" value="1" required>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Create</button>
</div>
</form>
<div id="keysList"></div>
</div>

<% } else if (page === 'radar-list') { %>
<div class="section">
<h3 class="section-title">üéØ Radar List</h3>
<p style="color: #9ca3af; margin-bottom: 20px;">Users with roles in this list will be subject to penalties from other protection pages when they exceed Guard limits.</p>
<form id="radarForm">
<div class="form-group">
<label>Add Radar Role</label>
<select name="radarRole" id="radarRoleSelect" required>
<option value="">Select role</option>
</select>
<button type="button" class="btn btn-success" onclick="addRadarRole()" style="margin-top: 10px;"><i class="fas fa-plus"></i> Add</button>
</div>
</form>
<div id="radarRolesList" style="margin-top: 20px;"></div>
</div>

<% } else if (page === 'channel-protection') { %>
<div class="section">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 class="section-title" style="margin: 0;">üì∫ Channel Protection</h3>
<label class="toggle-switch">
<input type="checkbox" id="channelProtectionToggle" onchange="toggleProtection('channel')">
<span class="toggle-slider"></span>
</label>
</div>
<form id="channelProtectionForm">
<div class="form-group">
<label>Channel Creation Limit</label>
<input type="number" name="channelCreateLimit" min="1" value="3" required>
</div>
<div class="form-group">
<label>Channel Deletion Limit</label>
<input type="number" name="channelDeleteLimit" min="1" value="2" required>
</div>
<div class="form-group">
<label style="display: flex; align-items: center; gap: 10px;">
<input type="checkbox" name="directChannelDeletionAction" style="width: auto; margin: 0;">
<span>Direct action on channel deletion (disabled by default)</span>
</label>
</div>
<div class="form-group">
<label>Action when limit exceeded</label>
<select name="channelAction" id="channelAction" required onchange="toggleRoleSelect('channelAction', 'channelAssignRole')">
<option value="kick">Kick</option>
<option value="ban">Ban</option>
<option value="removeRoles">Remove Roles</option>
</select>
</div>
<div class="form-group" id="channelAssignRole" style="display: none;">
<label>Assign Role</label>
<select name="channelAssignRoleId" id="channelAssignRoleSelect">
<option value="">Select role</option>
</select>
</div>
<div class="form-group">
<label>Reset Time (minutes)</label>
<input type="number" name="channelResetTime" min="1" value="60" required>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Settings</button>
</form>
</div>

<% } else if (page === 'member-protection') { %>
<div class="section">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 class="section-title" style="margin: 0;">üë• Member Protection</h3>
<label class="toggle-switch">
<input type="checkbox" id="memberProtectionToggle" onchange="toggleProtection('member')">
<span class="toggle-slider"></span>
</label>
</div>
<form id="memberProtectionForm">
<div class="form-group">
<label>Ban Limit</label>
<input type="number" name="banLimit" min="1" value="2" required>
</div>
<div class="form-group">
<label>Kick Limit</label>
<input type="number" name="kickLimit" min="1" value="5" required>
</div>
<div class="form-group">
<label>Timeout Limit</label>
<input type="number" name="timeoutLimit" min="1" value="10" required>
</div>
<div class="form-group">
<label>Action when limit exceeded</label>
<select name="memberAction" id="memberAction" required onchange="toggleRoleSelect('memberAction', 'memberAssignRole')">
<option value="kick">Kick</option>
<option value="ban">Ban</option>
<option value="removeRoles">Remove Roles</option>
</select>
</div>
<div class="form-group" id="memberAssignRole" style="display: none;">
<label>Assign Role</label>
<select name="memberAssignRoleId" id="memberAssignRoleSelect">
<option value="">Select role</option>
</select>
</div>
<div class="form-group">
<label>Reset Time (minutes)</label>
<input type="number" name="memberResetTime" min="1" value="60" required>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Settings</button>
</form>
</div>

<% } else if (page === 'role-protection') { %>
<div class="section">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 class="section-title" style="margin: 0;">üè∑Ô∏è Role Protection</h3>
<label class="toggle-switch">
<input type="checkbox" id="roleProtectionToggle" onchange="toggleProtection('role')">
<span class="toggle-slider"></span>
</label>
</div>
<form id="roleProtectionForm">
<div class="form-group">
<label>Role Creation Limit</label>
<input type="number" name="roleCreateLimit" min="1" value="3" required>
</div>
<div class="form-group">
<label>Role Deletion Limit</label>
<input type="number" name="roleDeleteLimit" min="1" value="2" required>
</div>
<div class="form-group">
<label>Action when limit exceeded</label>
<select name="roleAction" id="roleAction" required onchange="toggleRoleSelect('roleAction', 'roleAssignRole')">
<option value="kick">Kick</option>
<option value="ban">Ban</option>
<option value="removeRoles">Remove Roles</option>
</select>
</div>
<div class="form-group" id="roleAssignRole" style="display: none;">
<label>Assign Role</label>
<select name="roleAssignRoleId" id="roleAssignRoleSelect">
<option value="">Select role</option>
</select>
</div>
<div class="form-group">
<label>Reset Time (minutes)</label>
<input type="number" name="roleResetTime" min="1" value="60" required>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Settings</button>
</form>
</div>

<% } else if (page === 'guard-log') { %>
<div style="display: grid; grid-template-columns: 40% 60%; gap: 20px; height: calc(100vh - 200px);">
<div class="section" style="margin-bottom: 0; height: fit-content;">
<h3 class="section-title">üìã Guard Log Settings</h3>
<form id="guardLogForm">
<div class="form-group">
<label>Log Channel</label>
<select name="guardLogChannel" id="guardLogChannelSelect" required>
<option value="">Select channel</option>
</select>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Set Log Channel</button>
</form>

<div style="margin-top: 30px;">
<h4 style="color: #fff; margin-bottom: 15px; font-size: 16px;">üìä Guard Statistics</h4>
<div style="display: grid; gap: 15px;">
<div style="background: rgba(239,68,68,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #ef4444;">
<div style="color: #ef4444; font-size: 13px; margin-bottom: 5px;">Total Guard Events</div>
<div style="color: #fff; font-size: 20px; font-weight: 600;" id="totalGuardEvents">0</div>
</div>
<div style="background: rgba(239,68,68,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #ef4444;">
<div style="color: #ef4444; font-size: 13px; margin-bottom: 5px;">Active Protections</div>
<div style="color: #fff; font-size: 20px; font-weight: 600;" id="activeProtections">4</div>
</div>
<div style="background: rgba(16,185,129,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #10b981;">
<div style="color: #10b981; font-size: 13px; margin-bottom: 5px;">Last Action</div>
<div style="color: #fff; font-size: 20px; font-weight: 600;" id="lastGuardAction">-</div>
</div>
</div>
</div>
</div>

<div class="section" style="margin-bottom: 0; height: 100%;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="margin: 0; color: #fff; font-size: 18px; font-weight: 600;">üõ°Ô∏è Live Guard Logs</h3>
<button class="btn" onclick="refreshGuardLogs()" style="padding: 8px 16px; background: rgba(255,255,255,0.1); color: #fff; font-size: 12px;">
<i class="fas fa-sync-alt"></i> Refresh
</button>
</div>
<div class="logs-container" id="guardLogsContainer" style="height: calc(100% - 60px); max-height: none;">
<div id="guardLogsList" style="color: #9ca3af; text-align: center; padding: 40px;">
<i class="fas fa-shield-alt" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
<p>No guard events yet</p>
<p style="font-size: 12px; opacity: 0.7;">Guard logs will appear here when actions are triggered</p>
</div>
</div>
</div>
</div>

<% } %>
</div>

</main>
</div>
<div class="notification" id="notification">
<i class="fas fa-check-circle"></i>
<span id="notificationText"></span>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
setInterval(() => socket.emit('checkBan', '<%= user.id %>'), 5000);
socket.on('banned', () => window.location.href = '/banned');

function toggleCategory(id) {
const content = document.getElementById(id + '-content');
const toggleIcon = content.previousElementSibling.querySelector('.toggle-icon');

content.classList.toggle('collapsed');
toggleIcon.classList.toggle('rotated');

// Save sidebar scroll position
const sidebar = document.querySelector('.sidebar-nav');
if (sidebar) {
localStorage.setItem('sidebar_scroll_position', sidebar.scrollTop);
}
}

// Function to restore scroll position with multiple attempts
function restoreScrollPosition() {
const savedScrollPos = localStorage.getItem('sidebar_scroll_position');
if (savedScrollPos) {
const sidebar = document.querySelector('.sidebar-nav');
if (sidebar) {
const targetScrollTop = parseInt(savedScrollPos);
sidebar.scrollTop = targetScrollTop;

// Multiple attempts to ensure scroll position is set
setTimeout(() => {
if (sidebar.scrollTop !== targetScrollTop) {
sidebar.scrollTop = targetScrollTop;
}
}, 100);

setTimeout(() => {
if (sidebar.scrollTop !== targetScrollTop) {
sidebar.scrollTop = targetScrollTop;
}
}, 300);
}
}
}

// Save scroll position function
function saveScrollPosition() {
const sidebar = document.querySelector('.sidebar-nav');
if (sidebar) {
localStorage.setItem('sidebar_scroll_position', sidebar.scrollTop);
}
}

// Restore scroll position when page loads (with delay)
window.addEventListener('load', () => {
setTimeout(restoreScrollPosition, 50);
});

// Also try on DOM ready
document.addEventListener('DOMContentLoaded', restoreScrollPosition);

// Save scroll position when leaving page
window.addEventListener('beforeunload', saveScrollPosition);

// Save scroll position more frequently
setInterval(saveScrollPosition, 500);

// Save scroll position on manual scroll
document.addEventListener('scroll', function(e) {
if (e.target.classList && e.target.classList.contains('sidebar-nav')) {
saveScrollPosition();
}
}, true);

function showNotification(message, isError = false) {
const notification = document.getElementById('notification');
const text = document.getElementById('notificationText');
text.textContent = message;
notification.className = 'notification ' + (isError ? 'error' : 'success');
notification.classList.add('show');
setTimeout(() => notification.classList.remove('show'), 3000);
}

<% if (page === 'dashboard') { %>
let startTime = Date.now();
setInterval(() => {
const uptime = Math.floor((Date.now() - startTime) / 1000);
const hours = Math.floor(uptime / 3600);
const minutes = Math.floor((uptime % 3600) / 60);
const seconds = uptime % 60;
document.getElementById('uptime').textContent = `${hours}h ${minutes}m ${seconds}s`;
}, 1000);
<% } %>

<% if (page === 'upgrade') { %>
document.getElementById('upgradeForm').addEventListener('submit', async (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const data = Object.fromEntries(formData);
try {
const res = await fetch('/api/upgrade', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(data)
});
const result = await res.json();
showNotification(result.message, !result.success);
if (result.success) setTimeout(() => location.reload(), 1500);
} catch(err) {
showNotification('Error: ' + err.message, true);
}
});
<% } %>

<% if (page === 'bot-setup') { %>
document.getElementById('configForm').addEventListener('submit', async (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const data = Object.fromEntries(formData);
try {
const res = await fetch('/api/config/save', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(data)
});
const result = await res.json();
showNotification(result.message, !result.success);
if (result.success) setTimeout(() => location.reload(), 1500);
} catch(err) {
showNotification('Error: ' + err.message, true);
}
});

function controlBot(action) {
fetch('/api/bot/control', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({action})
}).then(res => res.json()).then(result => {
showNotification(result.message, !result.success);
if (result.success) setTimeout(() => location.reload(), 1500);
});
}
<% } %>

<% if (['ingame-anc', 'activity-test', 'ticket', 'give-role'].includes(page)) { %>
fetch('/api/channels').then(res => res.json()).then(data => {
if (data.success) {
const textChannels = data.channels.filter(c => c.type === 'text');
const categories = data.channels.filter(c => c.type === 'category');
document.querySelectorAll('#channelSelect, #ticketChannelSelect').forEach(select => {
textChannels.forEach(ch => {
const opt = document.createElement('option');
opt.value = ch.id;
opt.textContent = ch.name;
select.appendChild(opt);
});
});
document.querySelectorAll('#ticketsCategorySelect, #closedCategorySelect').forEach(select => {
categories.forEach(cat => {
const opt = document.createElement('option');
opt.value = cat.id;
opt.textContent = cat.name;
select.appendChild(opt);
});
});
}
});

fetch('/api/roles').then(res => res.json()).then(data => {
if (data.success) {
document.querySelectorAll('#roleSelect, #unregRoleSelect, #staffRoleSelect').forEach(select => {
data.roles.forEach(role => {
const opt = document.createElement('option');
opt.value = role.id;
opt.textContent = role.name;
select.appendChild(opt);
});
});
}
});
<% } %>

<% if (page === 'ingame-anc') { %>
document.getElementById('ingameForm').addEventListener('submit', async (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const data = Object.fromEntries(formData);
try {
const res = await fetch('/api/ingame-anc', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(data)
});
const result = await res.json();
showNotification(result.message, !result.success);
} catch(err) {
showNotification('Error: ' + err.message, true);
}
});
<% } %>

<% if (page === 'activity-test') { %>
document.getElementById('activityForm').addEventListener('submit', async (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const data = Object.fromEntries(formData);
try {
const res = await fetch('/api/activity-test', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(data)
});
const result = await res.json();
showNotification(result.message, !result.success);
} catch(err) {
showNotification('Error: ' + err.message, true);
}
});
<% } %>

<% if (page === 'ticket') { %>
document.getElementById('ticketForm').addEventListener('submit', async (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const data = Object.fromEntries(formData);
try {
const res = await fetch('/api/ticket/setup', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(data)
});
const result = await res.json();
showNotification(result.message, !result.success);
} catch(err) {
showNotification('Error: ' + err.message, true);
}
});
<% } %>

<% if (page === 'dmanc') { %>
document.getElementById('dmForm').addEventListener('submit', async (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const data = Object.fromEntries(formData);
try {
const res = await fetch('/api/dm-anc', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(data)
});
const result = await res.json();
showNotification(result.message, !result.success);
} catch(err) {
showNotification('Error: ' + err.message, true);
}
});
<% } %>

<% if (page === 'give-role') { %>
document.getElementById('roleForm').addEventListener('submit', async (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const data = Object.fromEntries(formData);
try {
const res = await fetch('/api/give-role', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(data)
});
const result = await res.json();
showNotification(result.message, !result.success);
} catch(err) {
showNotification('Error: ' + err.message, true);
}
});
<% } %>

<% if (page === 'admin-users') { %>
function banUser(userId) {
if (!confirm('Are you sure you want to ban this user?')) return;
fetch('/api/admin/ban-user', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({userId})
}).then(res => res.json()).then(result => {
showNotification(result.message, !result.success);
if (result.success) setTimeout(() => location.reload(), 1500);
});
}

function unbanUser(userId) {
fetch('/api/admin/unban-user', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({userId})
}).then(res => res.json()).then(result => {
showNotification(result.message, !result.success);
if (result.success) setTimeout(() => location.reload(), 1500);
});
}

function resetHWID(userId) {
fetch('/api/admin/reset-hwid', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({userId})
}).then(res => res.json()).then(result => {
showNotification(result.message, !result.success);
});
}

function deleteUser(userId, username) {
if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone!`)) return;
fetch('/api/admin/delete-user', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({userId})
}).then(res => res.json()).then(result => {
showNotification(result.message, !result.success);
if (result.success) setTimeout(() => location.reload(), 1500);
});
}
<% } %>

<% if (page === 'admin-keys') { %>
document.getElementById('keyForm').addEventListener('submit', async (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const data = Object.fromEntries(formData);
try {
const res = await fetch('/api/admin/create-key', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(data)
});
const result = await res.json();
showNotification(result.message, !result.success);
if (result.success) {
loadKeys();
}
} catch(err) {
showNotification('Error: ' + err.message, true);
}
});

function loadKeys() {
fetch('/api/admin/keys').then(res => res.json()).then(data => {
if (data.success) {
const html = data.keys.map(k => `
<div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<code style="background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 6px; font-size: 13px;">${k.key}</code>
<span style="margin-left: 10px; color: #9ca3af; font-size: 13px;">${k.type.toUpperCase()}</span>
${k.used ? '<span style="margin-left: 10px; color: #ef4444;">‚úì Used</span>' : '<span style="margin-left: 10px; color: #10b981;">‚úì Available</span>'}
</div>
<div style="display: flex; gap: 8px;">
<button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="navigator.clipboard.writeText('${k.key}'); showNotification('Key copied!')"><i class="fas fa-copy"></i></button>
<button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteKey('${k.key}')"><i class="fas fa-trash"></i></button>
</div>
</div>
</div>
`).join('');
document.getElementById('keysList').innerHTML = html;
}
});
}

function deleteKey(key) {
if (!confirm('Are you sure you want to delete this key?')) return;
fetch('/api/admin/delete-key', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({key})
}).then(res => res.json()).then(result => {
showNotification(result.message, !result.success);
if (result.success) loadKeys();
});
}

loadKeys();
<% } %>

<% if (['radar-list', 'channel-protection', 'member-protection', 'role-protection', 'guard-log'].includes(page)) { %>
fetch('/api/channels').then(res => res.json()).then(data => {
if (data.success) {
const textChannels = data.channels.filter(c => c.type === 'text');
document.querySelectorAll('#guardLogChannelSelect').forEach(select => {
textChannels.forEach(ch => {
const opt = document.createElement('option');
opt.value = ch.id;
opt.textContent = ch.name;
select.appendChild(opt);
});
});
}
});

fetch('/api/roles').then(res => res.json()).then(data => {
if (data.success) {
document.querySelectorAll('#radarRoleSelect, #channelAssignRoleSelect, #memberAssignRoleSelect, #roleAssignRoleSelect').forEach(select => {
data.roles.forEach(role => {
const opt = document.createElement('option');
opt.value = role.id;
opt.textContent = role.name;
select.appendChild(opt);
});
});
}
});

// Toggle role select visibility based on punishment type
function toggleRoleSelect(selectId, targetId) {
const select = document.getElementById(selectId);
const target = document.getElementById(targetId);
if (select && target) {
if (select.value === 'removeRoles') {
target.style.display = 'block';
} else {
target.style.display = 'none';
}
}
}

// Load saved settings on page load without auto-activation
<% if (page === 'channel-protection') { %>
const existingSettings = <%- JSON.stringify(user.guardSettings?.channelProtection || {}) %>;
if (existingSettings.createLimit) document.querySelector('[name="channelCreateLimit"]').value = existingSettings.createLimit;
if (existingSettings.deleteLimit) document.querySelector('[name="channelDeleteLimit"]').value = existingSettings.deleteLimit;
if (existingSettings.action) document.querySelector('[name="channelAction"]').value = existingSettings.action;
if (existingSettings.resetTime) document.querySelector('[name="channelResetTime"]').value = existingSettings.resetTime / 60000;
if (existingSettings.action === 'removeRoles') {
document.getElementById('channelAssignRole').style.display = 'block';
}
if (existingSettings.enabled !== undefined) {
document.getElementById('channelProtectionToggle').checked = existingSettings.enabled;
}
<% } else if (page === 'member-protection') { %>
const existingSettings = <%- JSON.stringify(user.guardSettings?.memberProtection || {}) %>;
if (existingSettings.banLimit) document.querySelector('[name="banLimit"]').value = existingSettings.banLimit;
if (existingSettings.kickLimit) document.querySelector('[name="kickLimit"]').value = existingSettings.kickLimit;
if (existingSettings.timeoutLimit) document.querySelector('[name="timeoutLimit"]').value = existingSettings.timeoutLimit;
if (existingSettings.action) document.querySelector('[name="memberAction"]').value = existingSettings.action;
if (existingSettings.resetTime) document.querySelector('[name="memberResetTime"]').value = existingSettings.resetTime / 60000;
if (existingSettings.action === 'removeRoles') {
document.getElementById('memberAssignRole').style.display = 'block';
}
if (existingSettings.enabled !== undefined) {
document.getElementById('memberProtectionToggle').checked = existingSettings.enabled;
}
<% } else if (page === 'role-protection') { %>
const existingSettings = <%- JSON.stringify(user.guardSettings?.roleProtection || {}) %>;
if (existingSettings.createLimit) document.querySelector('[name="roleCreateLimit"]').value = existingSettings.createLimit;
if (existingSettings.deleteLimit) document.querySelector('[name="roleDeleteLimit"]').value = existingSettings.deleteLimit;
if (existingSettings.action) document.querySelector('[name="roleAction"]').value = existingSettings.action;
if (existingSettings.resetTime) document.querySelector('[name="roleResetTime"]').value = existingSettings.resetTime / 60000;
if (existingSettings.action === 'removeRoles') {
document.getElementById('roleAssignRole').style.display = 'block';
}
if (existingSettings.enabled !== undefined) {
document.getElementById('roleProtectionToggle').checked = existingSettings.enabled;
}
<% } %>
<% } %>

<% if (page === 'radar-list') { %>
function addRadarRole() {
const select = document.getElementById('radarRoleSelect');
const roleId = select.value;
const roleName = select.options[select.selectedIndex].text;
if (!roleId) return;

fetch('/api/guard/radar/add-role', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({roleId, roleName})
}).then(res => res.json()).then(result => {
showNotification(result.message, !result.success);
if (result.success) loadRadarRoles();
});
}

function removeRadarRole(roleId) {
fetch('/api/guard/radar/remove-role', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({roleId})
}).then(res => res.json()).then(result => {
showNotification(result.message, !result.success);
if (result.success) loadRadarRoles();
});
}

function loadRadarRoles() {
fetch('/api/guard/radar/roles').then(res => res.json()).then(data => {
if (data.success) {
const html = data.roles.map(role => `
<div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<span style="color: #fff; font-weight: 500;">${role.name}</span>
<span style="color: #9ca3af; font-size: 13px; margin-left: 10px;">ID: ${role.id}</span>
</div>
<button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="removeRadarRole('${role.id}')"><i class="fas fa-trash"></i></button>
</div>
</div>
`).join('');
document.getElementById('radarRolesList').innerHTML = html || '<p style="color: #9ca3af; text-align: center;">No radar roles added yet</p>';
}
});
}

loadRadarRoles();
<% } %>

<% if (page === 'channel-protection') { %>
document.getElementById('channelProtectionForm').addEventListener('submit', async (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const data = Object.fromEntries(formData);
// Store settings in localStorage for persistence
localStorage.setItem('channelProtectionSettings', JSON.stringify(data));
try {
const res = await fetch('/api/guard/channel-protection', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(data)
});
const result = await res.json();
showNotification(result.message, !result.success);
} catch(err) {
showNotification('Error: ' + err.message, true);
}
});

// Load settings from localStorage on page load
const savedSettings = localStorage.getItem('channelProtectionSettings');
if (savedSettings) {
const settings = JSON.parse(savedSettings);
if (settings.channelCreateLimit) document.querySelector('[name="channelCreateLimit"]').value = settings.channelCreateLimit;
if (settings.channelDeleteLimit) document.querySelector('[name="channelDeleteLimit"]').value = settings.channelDeleteLimit;
if (settings.channelAction) document.querySelector('[name="channelAction"]').value = settings.channelAction;
if (settings.channelResetTime) document.querySelector('[name="channelResetTime"]').value = settings.channelResetTime;
if (settings.directChannelDeletionAction) document.querySelector('[name="directChannelDeletionAction"]').checked = settings.directChannelDeletionAction === 'on';
if (settings.channelAction === 'removeRoles') {
document.getElementById('channelAssignRole').style.display = 'block';
}
}
<% } %>

<% if (page === 'member-protection') { %>
document.getElementById('memberProtectionForm').addEventListener('submit', async (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const data = Object.fromEntries(formData);
try {
const res = await fetch('/api/guard/member-protection', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(data)
});
const result = await res.json();
showNotification(result.message, !result.success);
} catch(err) {
showNotification('Error: ' + err.message, true);
}
});
<% } %>

<% if (page === 'role-protection') { %>
document.getElementById('roleProtectionForm').addEventListener('submit', async (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const data = Object.fromEntries(formData);
try {
const res = await fetch('/api/guard/role-protection', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(data)
});
const result = await res.json();
showNotification(result.message, !result.success);
} catch(err) {
showNotification('Error: ' + err.message, true);
}
});
<% } %>

<% if (page === 'guard-log') { %>
document.getElementById('guardLogForm').addEventListener('submit', async (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const data = Object.fromEntries(formData);
try {
const res = await fetch('/api/guard/log-settings', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(data)
});
const result = await res.json();
showNotification(result.message, !result.success);
} catch(err) {
showNotification('Error: ' + err.message, true);
}
});

function refreshGuardLogs() {
fetch('/api/guard/logs').then(res => res.json()).then(data => {
if (data.success) {
const container = document.getElementById('guardLogsList');
if (data.logs && data.logs.length > 0) {
const html = data.logs.map(log => `
<div class="log-item log-${log.type}">
[${new Date(log.timestamp).toLocaleString('en-US')}] ${log.message}
</div>
`).join('');
container.innerHTML = html;
document.getElementById('totalGuardEvents').textContent = data.logs.length;
document.getElementById('lastGuardAction').textContent = data.logs[0] ? new Date(data.logs[0].timestamp).toLocaleTimeString('en-US') : '-';
} else {
container.innerHTML = `
<div style="color: #9ca3af; text-align: center; padding: 40px;">
<i class="fas fa-shield-alt" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
<p>No guard events yet</p>
<p style="font-size: 12px; opacity: 0.7;">Guard logs will appear here when actions are triggered</p>
</div>
`;
}
}
}).catch(err => {
console.error('Error loading guard logs:', err);
});
}

// Auto-refresh guard logs every 5 seconds
setInterval(refreshGuardLogs, 5000);
// Initial load
refreshGuardLogs();
<% } %>

// Guard protection toggle functions
function toggleProtection(type) {
    const toggle = document.getElementById(type + 'ProtectionToggle');
    const isEnabled = toggle.checked;
    
    fetch('/api/guard/' + type + '-toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enabled: isEnabled})
    }).then(res => res.json()).then(result => {
        showNotification(result.message, !result.success);
    }).catch(err => {
        showNotification('Error: ' + err.message, true);
    });
}

</script>
</body>
</html>
